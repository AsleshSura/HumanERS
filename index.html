<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒŠ HumanERS - Enhanced Emotion Recognition</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Enhanced status indicators */
        .status-dot {
            transition: all 0.3s ease;
            position: relative;
        }
        .status-dot.active {
            box-shadow: 0 0 10px #00ff00;
        }
        .status-dot.error {
            box-shadow: 0 0 10px #ff0000;
        }
        
        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
            font-size: 1.2em;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Better modal styling */
        .modal-content {
            animation: modalSlideIn 0.5s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { transform: scale(0.7); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* Debug toggle */
        .debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid #333;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            z-index: 9000;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div>Loading AI models... Please wait</div>
    </div>

    <!-- Permission Request Modal -->
    <div id="permissionModal" class="modal">
        <div class="modal-content">
            <h2>ğŸŒŠ HumanERS</h2>
            <p>Enhanced Emotion Recognition System</p>
            <div class="permission-icon">ğŸ“¹ğŸ¤</div>
            <div class="permission-symbols">
                ğŸ‘ï¸ âœ‹ ğŸ¤ ğŸ¨
            </div>
            <p style="font-size: 14px; color: #aaa; margin: 20px 0;">
                This system uses AI to detect emotions through facial expressions, 
                gestures, and audio. All processing happens locally in your browser.
            </p>
            <button id="grantPermissions" class="start-btn">ğŸš€ Start System</button>
            <div style="margin-top: 15px;">
                <button onclick="openDebugMode()" style="background: #333; color: #ccc; border: 1px solid #666; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
                    ğŸ”§ Debug Mode
                </button>
                <button onclick="openDemo()" style="background: #333; color: #ccc; border: 1px solid #666; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                    ğŸ® Demo Mode
                </button>
            </div>
        </div>
    </div>

    <!-- Main Interface -->
    <div id="mainInterface" class="hidden">
        <!-- Background Canvas for Dynamic Effects -->
        <canvas id="backgroundCanvas"></canvas>
        
        <!-- Touch Canvas for Color Painting -->
        <canvas id="touchCanvas"></canvas>
        
        <!-- Main Canvas for rendering (added for compatibility) -->
        <canvas id="mainCanvas"></canvas>
        
        <!-- Video Feed (Hidden) -->
        <video id="video" autoplay muted playsinline style="display: none;"></video>
        
        <!-- Status Indicators (Enhanced) -->
        <div id="statusIndicators">
            <div class="status-dot camera-status" title="Camera & Face Detection">ğŸ“¹</div>
            <div class="status-dot mic-status" title="Microphone & Audio Analysis">ğŸ¤</div>
            <div class="status-dot gesture-status" title="Hand Gesture Recognition">âœ‹</div>
            <div class="status-dot eye-status" title="Eye Tracking">ğŸ‘ï¸</div>
            <div class="status-dot motion-status" title="Device Motion">ğŸ“±</div>
        </div>

        <!-- Threat Level Display -->
        <div id="threatDisplay">
            <div id="threatSymbol">ğŸ”ï¸</div>
            <div id="threatMeter"></div>
        </div>

        <!-- Particle System Container -->
        <div id="particleContainer"></div>
        
        <!-- Warning Symbols Overlay -->
        <div id="warningOverlay"></div>
    </div>

    <!-- Emotion Display Panel (Hidden Initially) -->
    <div id="emotionPanel" class="emotion-panel hidden">
        <h3>ğŸ­ Detected Emotions</h3>
        <div class="emotion-bars">
            <div class="emotion-bar">
                <label>ğŸ˜Š Happy:</label>
                <div class="bar-container">
                    <div class="bar-fill" id="happy-bar"></div>
                    <span class="bar-value" id="happy-value">0%</span>
                </div>
            </div>
            <div class="emotion-bar">
                <label>ğŸ˜¢ Sad:</label>
                <div class="bar-container">
                    <div class="bar-fill" id="sad-bar"></div>
                    <span class="bar-value" id="sad-value">0%</span>
                </div>
            </div>
            <div class="emotion-bar">
                <label>ğŸ˜  Angry:</label>
                <div class="bar-container">
                    <div class="bar-fill" id="angry-bar"></div>
                    <span class="bar-value" id="angry-value">0%</span>
                </div>
            </div>
            <div class="emotion-bar">
                <label>ğŸ˜± Fear:</label>
                <div class="bar-container">
                    <div class="bar-fill" id="fearful-bar"></div>
                    <span class="bar-value" id="fearful-value">0%</span>
                </div>
            </div>
            <div class="emotion-bar">
                <label>ğŸ˜® Surprised:</label>
                <div class="bar-container">
                    <div class="bar-fill" id="surprised-bar"></div>
                    <span class="bar-value" id="surprised-value">0%</span>
                </div>
            </div>
            <div class="emotion-bar">
                <label>ğŸ˜ Neutral:</label>
                <div class="bar-container">
                    <div class="bar-fill" id="neutral-bar"></div>
                    <span class="bar-value" id="neutral-value">0%</span>
                </div>
            </div>
            <div class="emotion-bar">
                <label>ğŸ¤¢ Disgusted:</label>
                <div class="bar-container">
                    <div class="bar-fill" id="disgusted-bar"></div>
                    <span class="bar-value" id="disgusted-value">0%</span>
                </div>
            </div>
        </div>
        <div class="overall-intensity">
            <label>ğŸŒ¡ï¸ Overall Intensity:</label>
            <div class="intensity-meter">
                <div class="bar-container">
                    <div class="intensity-fill" id="intensity-fill"></div>
                </div>
                <span class="intensity-value" id="intensity-value">20%</span>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel" style="
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.9);
        color: #00ff00;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        max-width: 300px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #333;
        z-index: 9000;
        display: block;
    ">
        <div style="color: #fff; font-weight: bold; margin-bottom: 10px;">ğŸ”§ Debug Info</div>
        <div id="debugContent">
            <div>Touch Points: <span id="debug-touch">0</span></div>
            <div>Audio Level: <span id="debug-audio">0%</span></div>
            <div>Motion Score: <span id="debug-motion">0%</span></div>
            <div>Detection Mode: <span id="debug-mode">Initializing...</span></div>
            <div>Threat Level: <span id="debug-threat">0%</span></div>
        </div>
    </div>

    <!-- Debug Toggle -->
    <button class="debug-toggle" onclick="toggleDebugMode()">ğŸ”§ Debug</button>

    <!-- AI Libraries with timeout handling -->
    <script>
        // Track loading progress
        let librariesLoaded = 0;
        const totalLibraries = 4;
        
        function updateLoadingProgress() {
            librariesLoaded++;
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                const text = overlay.querySelector('div:last-child');
                if (text) {
                    text.textContent = `Loading AI models... (${librariesLoaded}/${totalLibraries})`;
                }
                
                if (librariesLoaded >= totalLibraries) {
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                    }, 1000);
                }
            }
        }
        
        // Load libraries with error handling
        function loadScript(src, name) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`âœ… ${name} loaded successfully`);
                    updateLoadingProgress();
                    resolve();
                };
                script.onerror = () => {
                    console.error(`âŒ Failed to load ${name}`);
                    updateLoadingProgress();
                    resolve(); // Still resolve to continue loading other scripts
                };
                
                // Timeout after 15 seconds
                setTimeout(() => {
                    if (!script.onload) {
                        console.warn(`â° ${name} loading timeout`);
                        updateLoadingProgress();
                        resolve();
                    }
                }, 15000);
                
                document.head.appendChild(script);
            });
        }
        
        // Load all libraries
        Promise.all([
            loadScript('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js', 'TensorFlow.js'),
            loadScript('https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@0.0.6/dist/handpose.min.js', 'HandPose'),
            loadScript('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js', 'Face-API.js'),
            loadScript('https://webgazer.cs.brown.edu/webgazer.js', 'WebGazer')
        ]).then(() => {
            console.log('ğŸ‰ All AI libraries loaded');
        }).catch(error => {
            console.error('âŒ Error loading AI libraries:', error);
        });
    </script>
    
    <!-- Utility functions -->
    <script>
        function openDebugMode() {
            window.open('debug.html', '_blank');
        }
        
        function openDemo() {
            window.open('demo.html', '_blank');
        }
        
        function toggleDebugMode() {
            const debugPanel = document.getElementById('debugPanel');
            if (debugPanel) {
                debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
            }
            
            if (window.survivalSystem) {
                window.survivalSystem.debugMode = !window.survivalSystem.debugMode;
                console.log('Debug mode:', window.survivalSystem.debugMode ? 'ON' : 'OFF');
            }
        }
        
        // Update debug panel periodically
        setInterval(() => {
            if (window.survivalSystem) {
                const sys = window.survivalSystem;
                
                // Update debug display elements if they exist
                const debugTouch = document.getElementById('debug-touch');
                const debugAudio = document.getElementById('debug-audio');
                const debugMotion = document.getElementById('debug-motion');
                const debugMode = document.getElementById('debug-mode');
                const debugThreat = document.getElementById('debug-threat');
                
                if (debugTouch) debugTouch.textContent = sys.touchPoints ? sys.touchPoints.length : 0;
                if (debugAudio) debugAudio.textContent = sys.audioLevel ? (sys.audioLevel * 100).toFixed(1) + '%' : '0%';
                if (debugMotion) debugMotion.textContent = sys.motionScore ? (sys.motionScore * 100).toFixed(1) + '%' : '0%';
                if (debugThreat) debugThreat.textContent = sys.threatLevel ? (sys.threatLevel * 100).toFixed(1) + '%' : '0%';
                
                if (debugMode) {
                    let mode = 'Simulation';
                    if (sys.permissions && sys.permissions.camera && sys.models && sys.models.faceApi && sys.models.faceApi.loaded) {
                        mode = 'AI Face Detection';
                    } else if (sys.permissions && sys.permissions.camera) {
                        mode = 'Camera + Simulation';
                    }
                    debugMode.textContent = mode;
                }
            }
        }, 500);
        
        // Quick fix to ensure the permission modal works immediately
        document.addEventListener('DOMContentLoaded', function() {
            const startBtn = document.getElementById('grantPermissions');
            const modal = document.getElementById('permissionModal');
            const mainInterface = document.getElementById('mainInterface');
            
            if (startBtn) {
                startBtn.addEventListener('click', function() {
                    console.log('ğŸš€ Start button clicked');
                    
                    // Show loading overlay
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    if (loadingOverlay) loadingOverlay.classList.remove('hidden');
                    
                    // Hide modal and show main interface immediately
                    modal.classList.add('hidden');
                    mainInterface.classList.remove('hidden');
                    
                    // Initialize the system
                    if (window.survivalSystem) {
                        window.survivalSystem.requestPermissions().finally(() => {
                            // Hide loading overlay when done
                            if (loadingOverlay) loadingOverlay.classList.add('hidden');
                        });
                    }
                });
            }
        });
    </script>
    
    <!-- Main Application Script -->
    <script src="script.js"></script>
</body>
</html>
